{
    "$schema": "https://schema.management.azure.com/schemas/2019-08-01/tenantDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "topLevelManagementGroupPrefix": {
            "type": "string",
            "maxLength": 5
        }        
    },
    "variables": {
        "intranetScope": "[concat('/providers/Microsoft.Management/managementGroups/', parameters('topLevelManagementGroupPrefix'), '-internal')]",
        "policyDefinitions": {
            "allowedIntranetResourceTypes": "/providers/Microsoft.Authorization/policyDefinitions/a08ec900-254a-4555-9bf5-e42af04b5c5c",
            "denyIntranetPublicPaaSEndpoints": "[concat('/providers/Microsoft.Management/managementGroups/', parameters('topLevelManagementGroupPrefix'), '/providers/Microsoft.Authorization/policySetDefinitions/Deny-PublicEndpoints')]",
            "enforceIntranetSubnetRouteTable": "[concat('/providers/Microsoft.Management/managementGroups/', parameters('topLevelManagementGroupPrefix'), '/providers/Microsoft.Authorization/policyDefinitions/Enforce-Subn-RouteTable')]"
        },
        "policyAssignmentNames": {
            "allowedIntranetResourceTypes": "Allowed-Intra-Resources",
            "denyIntranetPublicPaaSEndpoints": "Deny-Intra-PaaS-Endpoint",
            "enforceIntranetSubnetRouteTable": "Enforce-Intra-RouteTable"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Authorization/policyAssignments",
            "apiVersion": "2018-05-01",
            "name": "[variables('policyAssignmentNames').allowedIntranetResourceTypes]",
            "location": "[deployment().location]",
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "description": "Allowed-Intra-Resources",
                "displayName": "Allowed-Intra-Resources",
                "policyDefinitionId": "[variables('policyDefinitions').allowedIntranetResourceTypes]",
                "scope": "[variables('intranetScope')]",
                "parameters": {
                    "listOfResourceTypesAllowed": {
                        "value": 
                        [  
                            "microsoft.compute/availabilitySets",
                            "microsoft.compute/virtualMachines",
                            "microsoft.compute/virtualMachines/extensions",
                            "microsoft.compute/virtualMachineScaleSets",
                            "microsoft.compute/virtualMachineScaleSets/extensions",
                            "microsoft.compute/virtualMachineScaleSets/virtualMachines",
                            "microsoft.compute/virtualMachineScaleSets/virtualMachines/extensions",
                            "microsoft.compute/virtualMachineScaleSets/networkInterfaces",
                            "microsoft.compute/virtualMachineScaleSets/virtualMachines/networkInterfaces",
                            "microsoft.compute/operations",
                            "microsoft.compute/restorePointCollections",
                            "microsoft.compute/restorePointCollections/restorePoints",
                            "microsoft.compute/proximityPlacementGroups",
                            "microsoft.compute/sshPublicKeys",
                            "microsoft.compute/locations/spotEvictionRates",
                            "microsoft.compute/locations/spotPriceHistory",
                            "microsoft.compute/sharedVMImages",
                            "microsoft.compute/sharedVMImages/versions",
                            "microsoft.compute/locations/artifactPublishers",
                            "microsoft.compute/locations/capsoperations",
                            "microsoft.compute/galleries",
                            "microsoft.compute/galleries/images",
                            "microsoft.compute/galleries/images/versions",
                            "microsoft.compute/locations/galleries",
                            "microsoft.compute/disks",
                            "microsoft.compute/snapshots",
                            "microsoft.compute/locations/diskoperations",
                            "microsoft.compute/diskEncryptionSets",
                            "microsoft.compute/diskAccesses",
                            "microsoft.compute/images",
                            "microsoft.compute/hostGroups",
                            "microsoft.compute/hostGroups/hosts",
                            "Microsoft.Network/virtualNetworks",
                            "Microsoft.Network/customIpPrefixes",
                            "Microsoft.Network/networkInterfaces",
                            "Microsoft.Network/privateEndpoints",
                            "Microsoft.Network/privateEndpointRedirectMaps",
                            "Microsoft.Network/loadBalancers",
                            "Microsoft.Network/networkSecurityGroups",
                            "Microsoft.Network/applicationSecurityGroups",
                            "Microsoft.Network/serviceEndpointPolicies",
                            "Microsoft.Network/networkIntentPolicies",
                            "Microsoft.Network/routeTables",
                            "Microsoft.Network/ddosCustomPolicies",
                            "Microsoft.Network/networkWatchers",
                            "Microsoft.Network/networkWatchers/connectionMonitors",
                            "Microsoft.Network/networkWatchers/flowLogs",
                            "Microsoft.Network/networkWatchers/pingMeshes",
                            "Microsoft.Network/bastionHosts",
                            "Microsoft.Network/applicationGateways",
                            "Microsoft.Network/applicationGatewayWebApplicationFirewallPolicies",
                            "Microsoft.Network/locations",
                            "Microsoft.Network/locations/operations",
                            "Microsoft.Network/locations/operationResults",
                            "Microsoft.Network/locations/CheckDnsNameAvailability",
                            "Microsoft.Network/locations/setLoadBalancerFrontendPublicIpAddresses",
                            "Microsoft.Network/locations/usages",
                            "Microsoft.Network/locations/virtualNetworkAvailableEndpointServices",
                            "Microsoft.Network/locations/availableDelegations",
                            "Microsoft.Network/locations/serviceTags",
                            "Microsoft.Network/locations/availablePrivateEndpointTypes",
                            "Microsoft.Network/locations/availableServiceAliases",
                            "Microsoft.Network/locations/checkPrivateLinkServiceVisibility",
                            "Microsoft.Network/locations/autoApprovedPrivateLinkServices",
                            "Microsoft.Network/locations/batchValidatePrivateEndpointsForResourceMove",
                            "Microsoft.Network/locations/batchNotifyPrivateEndpointsForResourceMove",
                            "Microsoft.Network/locations/supportedVirtualMachineSizes",
                            "Microsoft.Network/locations/checkAcceleratedNetworkingSupport",
                            "Microsoft.Network/locations/validateResourceOwnership",
                            "Microsoft.Network/locations/setResourceOwnership",
                            "Microsoft.Network/locations/effectiveResourceOwnership",
                            "Microsoft.Network/operations",
                            "Microsoft.Network/dnszones",
                            "Microsoft.Network/dnsOperationResults",
                            "Microsoft.Network/dnsOperationStatuses",
                            "Microsoft.Network/getDnsResourceReference",
                            "Microsoft.Network/internalNotify",
                            "Microsoft.Network/dnszones/A",
                            "Microsoft.Network/dnszones/AAAA",
                            "Microsoft.Network/dnszones/CNAME",
                            "Microsoft.Network/dnszones/PTR",
                            "Microsoft.Network/dnszones/MX",
                            "Microsoft.Network/dnszones/TXT",
                            "Microsoft.Network/dnszones/SRV",
                            "Microsoft.Network/dnszones/SOA",
                            "Microsoft.Network/dnszones/NS",
                            "Microsoft.Network/dnszones/CAA",
                            "Microsoft.Network/dnszones/recordsets",
                            "Microsoft.Network/dnszones/all",
                            "Microsoft.Network/privateDnsZones",
                            "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                            "Microsoft.Network/privateDnsOperationResults",
                            "Microsoft.Network/privateDnsOperationStatuses",
                            "Microsoft.Network/privateDnsZonesInternal",
                            "Microsoft.Network/privateDnsZones/A",
                            "Microsoft.Network/privateDnsZones/AAAA",
                            "Microsoft.Network/privateDnsZones/CNAME",
                            "Microsoft.Network/privateDnsZones/PTR",
                            "Microsoft.Network/privateDnsZones/MX",
                            "Microsoft.Network/privateDnsZones/TXT",
                            "Microsoft.Network/privateDnsZones/SRV",
                            "Microsoft.Network/privateDnsZones/SOA",
                            "Microsoft.Network/privateDnsZones/all",
                            "Microsoft.Network/virtualNetworks/privateDnsZoneLinks",
                            "Microsoft.Network/routeFilters",
                            "Microsoft.Network/bgpServiceCommunities",
                            "Microsoft.Network/locations/nfvOperations",
                            "Microsoft.Network/locations/nfvOperationResults",
                            "Microsoft.Network/securityPartnerProviders",
                            "Microsoft.Network/firewallPolicies",
                            "Microsoft.Network/ipGroups",
                            "Microsoft.Network/azureFirewalls",
                            "Microsoft.Network/azureFirewallFqdnTags",
                            "Microsoft.Network/applicationGatewayAvailableWafRuleSets",
                            "Microsoft.Network/applicationGatewayAvailableSslOptions",
                            "Microsoft.Network/applicationGatewayAvailableServerVariables",
                            "Microsoft.Network/applicationGatewayAvailableRequestHeaders",
                            "Microsoft.Network/applicationGatewayAvailableResponseHeaders",
                            "Microsoft.Network/virtualNetworkTaps",
                            "Microsoft.Network/privateLinkServices",
                            "Microsoft.Network/locations/privateLinkServices",
                            "Microsoft.Network/ddosProtectionPlans",
                            "Microsoft.Network/networkProfiles",
                            "Microsoft.Network/locations/bareMetalTenants",
                            "Microsoft.Network/virtualWans",
                            "Microsoft.Network/virtualHubs",
                            "Microsoft.Network/networkExperimentProfiles",
                            "Microsoft.RecoveryServices/vaults",
                            "Microsoft.RecoveryServices/operations",
                            "Microsoft.RecoveryServices/locations",
                            "Microsoft.RecoveryServices/locations/backupStatus",
                            "Microsoft.RecoveryServices/locations/checkNameAvailability",
                            "Microsoft.RecoveryServices/locations/backupValidateFeatures",
                            "Microsoft.RecoveryServices/locations/backupPreValidateProtection",
                            "Microsoft.RecoveryServices/locations/allocatedStamp",
                            "Microsoft.RecoveryServices/locations/allocateStamp",
                            "Microsoft.RecoveryServices/locations/backupCrrJobs",
                            "Microsoft.RecoveryServices/locations/backupCrrJob",
                            "Microsoft.RecoveryServices/locations/backupAadProperties",
                            "Microsoft.RecoveryServices/locations/backupCrossRegionRestore",
                            "Microsoft.RecoveryServices/locations/backupCrrOperationResults",
                            "Microsoft.RecoveryServices/locations/backupCrrOperationsStatus",
                            "Microsoft.RecoveryServices/backupProtectedItems",
                            "Microsoft.RecoveryServices/replicationEligibilityResults",
                            "Microsoft.Storage/deletedAccounts",
                            "Microsoft.Storage/locations/deletedAccounts",
                            "Microsoft.Storage/storageAccounts",
                            "Microsoft.Storage/storageAccounts/listAccountSas",
                            "Microsoft.Storage/storageAccounts/listServiceSas",
                            "Microsoft.Storage/operations",
                            "Microsoft.Storage/usages",
                            "Microsoft.Storage/checkNameAvailability",
                            "Microsoft.Storage/locations/checkNameAvailability",
                            "Microsoft.Storage/locations",
                            "Microsoft.Storage/locations/asyncoperations",
                            "Microsoft.Storage/locations/usages",
                            "Microsoft.Storage/locations/deleteVirtualNetworkOrSubnets",
                            "Microsoft.Storage/storageAccounts/blobServices",
                            "Microsoft.Storage/storageAccounts/tableServices",
                            "Microsoft.Storage/storageAccounts/queueServices",
                            "Microsoft.Storage/storageAccounts/fileServices"
                        ]
                    }
                }
            }
        },
        {
            "type": "Microsoft.Authorization/policyAssignments",
            "apiVersion": "2018-05-01",
            "name": "[variables('policyAssignmentNames').denyIntranetPublicPaaSEndpoints]",
            "location": "[deployment().location]",
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "description": "Deny-Intra-PaaS-Endpoint",
                "displayName": "Deny-Intra-PaaS-Endpoint",
                "policyDefinitionId": "[variables('policyDefinitions').denyIntranetPublicPaaSEndpoints]",
                "scope": "[variables('intranetScope')]",
                "parameters": {
                    "CosmosPublicIpDenyEffect": {
                        "value": "Deny"
                    },
                    "MariaDBPublicIpDenyEffect": {
                        "value": "Deny"
                    },
                    "MySQLPublicIpDenyEffect": {
                        "value": "Deny"
                    },
                    "PostgreSQLPublicIpDenyEffect": {
                        "value": "Deny"
                    },
                    "KeyVaultPublicIpDenyEffect": {
                        "value": "Deny"
                    },
                    "SqlServerPublicIpDenyEffect": {
                        "value": "Deny"
                    },
                    "StoragePublicIpDenyEffect": {
                        "value": "Deny"
                    },
                    "AKSPublicIpDenyEffect": {
                        "value": "Deny"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Authorization/policyAssignments",
            "apiVersion": "2018-05-01",
            "name": "[variables('policyAssignmentNames').enforceIntranetSubnetRouteTable]",
            "location": "[deployment().location]",
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "description": "Enforce-Intra-RouteTable",
                "displayName": "Enforce-Intra-RouteTable",
                "policyDefinitionId": "[variables('policyDefinitions').enforceIntranetSubnetRouteTable]",
                "scope": "[variables('intranetScope')]",
                "parameters": {
                    "routeTableResourceGroup": {
                        "value": "Locked"
                    },
                    "routeTableName": {
                        "value": "RouteTable"
                    }
                }
            }
        }
    ],
    "outputs": {}
}
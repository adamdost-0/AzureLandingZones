{
    "properties": {
        "displayName": "NSG X on every nic",
        "description": "This policy enforces a specific NSG on every virtual network interface",
        "parameters": {
            "nsgId": {
                "type": "string",
                "metadata": {
                    "description": "Resource Id of the Network Security Group",
                    "displayName": "Network Security Group Id"
                }
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Network/networkInterfaces"
                    },
                    {
                        "not": {
                            "field": "Microsoft.Network/networkInterfaces/networkSecurityGroup.id",
                            "equals": "[parameters('nsgId')]"
                        }
                    }
                ]
            },
            "then": {
                "effect": "DeployIfNotExists",
                "details": {
                    "type": "Microsoft.Network/networkInterfaces",
                    "roleDefinitionIds": [
                        "/subscriptions/{subscriptionId}/providers/Microsoft.Authorization/roleDefinitions/{roleGUID}",
                        "/providers/Microsoft.Authorization/roleDefinitions/{builtinroleGUID}"
                    ],
                    "existenceCondition": {
                        "not": {
                            "field": "Microsoft.Network/networkInterfaces/networkSecurityGroup.id",
                            "equals": "[parameters('nsgId')]"
                        }
                    },
                    "deployment": {
                        "properties": {
                            "mode": "Incremental",
                            "template": {
                            "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "resources": [
                                {
                                    "type": "Microsoft.Network/networkInterfaces",
                                    "apiVersion": "2020-05-01",
                                    "name": "testnic1",
                                    "location": "usgovvirginia",
                                    "properties": {
                                        "networkSecurityGroup": {
                                            "id": "/subscriptions/f86eed1f-a251-4b29-a8b3-98089b46ce6c/resourceGroups/nsgpolicy/providers/Microsoft.Network/networkSecurityGroups/default-nsg"
                                        },
                                        "ipConfigurations": [
                                            {
                                                "name": "ipconfig1",
                                                "properties": {
                                                    "subnet": {
                                                        "id": "[resourceId('nsgpolicy','Microsoft.Network/virtualNetworks/subnets', 'testvnet', 'default')]"								
                                                    }
                                                }
                                            }
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                }
            }
        }
    }
}